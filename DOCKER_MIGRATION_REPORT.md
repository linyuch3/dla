# ğŸ‰ CloudPanel Dockeré‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“Š é‡æ„æ¦‚è¿°

å·²æˆåŠŸå°†CloudPanelä»**Cloudflare Pages/Workers**æ¶æ„é‡æ„ä¸º**Dockeréƒ¨ç½²**æ¶æ„ï¼Œå®ç°äº†å®Œæ•´çš„åŠŸèƒ½è¿ç§»ï¼Œæ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ã€‚

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. Dockeré…ç½®æ–‡ä»¶ âœ“

- **Dockerfile** - å¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–é•œåƒå¤§å°
  - æ„å»ºé˜¶æ®µï¼šç¼–è¯‘TypeScript
  - ç”Ÿäº§é˜¶æ®µï¼šåªåŒ…å«å¿…éœ€æ–‡ä»¶
  - å¥åº·æ£€æŸ¥é…ç½®
  - érootç”¨æˆ·è¿è¡Œ

- **docker-compose.yml** - å®Œæ•´çš„æœåŠ¡ç¼–æ’
  - ç«¯å£æ˜ å°„ï¼š3000:3000
  - æ•°æ®æŒä¹…åŒ–å·é…ç½®
  - ç¯å¢ƒå˜é‡é…ç½®
  - ç½‘ç»œé…ç½®
  - èµ„æºé™åˆ¶é€‰é¡¹

- **.dockerignore** - ä¼˜åŒ–æ„å»ºä¸Šä¸‹æ–‡
- **.env.example** - ç¯å¢ƒå˜é‡æ¨¡æ¿

### 2. æ ¸å¿ƒæœåŠ¡å™¨æ–‡ä»¶ âœ“

- **functions/server.ts** - Expressä¸»æœåŠ¡å™¨
  - é›†æˆExpressæ¡†æ¶
  - é™æ€æ–‡ä»¶æœåŠ¡
  - APIè·¯ç”±åŠ è½½
  - æ•°æ®åº“åˆå§‹åŒ–
  - å®šæ—¶ä»»åŠ¡å¯åŠ¨
  - ä¼˜é›…å…³é—­å¤„ç†

- **functions/config.ts** - é…ç½®ç®¡ç†
  - ç¯å¢ƒå˜é‡åŠ è½½
  - é…ç½®éªŒè¯
  - ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®

- **functions/scheduler.ts** - å®šæ—¶ä»»åŠ¡
  - Cronè°ƒåº¦å™¨
  - APIå¯†é’¥å¥åº·æ£€æŸ¥
  - Telegramé€šçŸ¥

### 3. æ•°æ®å±‚é€‚é… âœ“

- **functions/shared/db-adapter.ts** - SQLiteé€‚é…å™¨
  - å®Œå…¨å…¼å®¹D1æ¥å£
  - SQLiteæ•°æ®åº“å°è£…
  - é¢„å¤„ç†è¯­å¥æ”¯æŒ
  - æ‰¹é‡æ“ä½œæ”¯æŒ

- **functions/shared/kv-adapter.ts** - KVå­˜å‚¨é€‚é…å™¨
  - æ–‡ä»¶ç³»ç»Ÿå®ç°
  - å®Œå…¨å…¼å®¹KVæ¥å£
  - è¿‡æœŸæ—¶é—´æ”¯æŒ
  - å…ƒæ•°æ®æ”¯æŒ

- **functions/shared/db-init.ts** - æ•°æ®åº“åˆå§‹åŒ–
  - è‡ªåŠ¨è¿è¡Œè¿ç§»
  - ç®¡ç†å‘˜è´¦æˆ·åˆ›å»º
  - æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥

### 4. ä¸­é—´ä»¶ç³»ç»Ÿ âœ“

- **functions/middleware/cors.ts** - CORSå¤„ç†
- **functions/middleware/session.ts** - Sessionç®¡ç†
- **functions/middleware/auth.ts** - è®¤è¯æˆæƒ
- **functions/middleware/error-handler.ts** - é”™è¯¯å¤„ç†

### 5. è·¯ç”±ç³»ç»Ÿ âœ“

- **functions/routes/index.ts** - è·¯ç”±ä¸»æ–‡ä»¶
- **functions/routes/api-loader.ts** - åŠ¨æ€APIåŠ è½½
  - è‡ªåŠ¨æ‰«æAPIç›®å½•
  - æ”¯æŒåŠ¨æ€è·¯ç”±å‚æ•°
  - Cloudflare Functions â†’ Expressè½¬æ¢

### 6. é…ç½®æ›´æ–° âœ“

- **package.json** - ä¾èµ–å’Œè„šæœ¬æ›´æ–°
  ```json
  æ–°å¢ä¾èµ–:
  - express: Webæ¡†æ¶
  - better-sqlite3: SQLiteæ•°æ®åº“
  - dotenv: ç¯å¢ƒå˜é‡
  - cron: å®šæ—¶ä»»åŠ¡
  
  æ–°å¢è„šæœ¬:
  - dev: å¼€å‘æ¨¡å¼
  - build: ç¼–è¯‘TypeScript
  - start: å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
  - docker:build/run/stop: Dockeræ“ä½œ
  ```

- **tsconfig.docker.json** - TypeScripté…ç½®
  - ES Moduleæ”¯æŒ
  - Node.jsç±»å‹
  - è¾“å‡ºé…ç½®

### 7. æ–‡æ¡£ âœ“

- **DOCKER_DEPLOYMENT.md** - è¯¦ç»†éƒ¨ç½²æŒ‡å—
  - å¿«é€Ÿå¼€å§‹
  - é…ç½®è¯´æ˜
  - å¸¸ç”¨å‘½ä»¤
  - åå‘ä»£ç†é…ç½®
  - å®‰å…¨å»ºè®®
  - æ•…éšœæ’æŸ¥
  - æ€§èƒ½ä¼˜åŒ–
  - è¿ç§»æŒ‡å—

- **DOCKER_README.md** - å¿«é€Ÿå…¥é—¨æ–‡æ¡£
- **DOCKER_CHANGELOG.md** - å˜æ›´æ—¥å¿—
- **start-docker.sh** - è‡ªåŠ¨åŒ–å¯åŠ¨è„šæœ¬
- **.gitignore** - æ›´æ–°å¿½ç•¥è§„åˆ™

---

## ğŸ”„ æ¶æ„å˜æ›´å¯¹æ¯”

| ç»„ä»¶ | Cloudflareç‰ˆæœ¬ | Dockerç‰ˆæœ¬ |
|------|----------------|------------|
| **è¿è¡Œæ—¶** | Cloudflare Workers | Node.js 20 + Express |
| **æ•°æ®åº“** | D1 (SQLite on Edge) | SQLite (better-sqlite3) |
| **å­˜å‚¨** | KV Namespace | æ–‡ä»¶ç³»ç»Ÿ |
| **è·¯ç”±** | Cloudflare Functions | Express Router |
| **éƒ¨ç½²** | Cloudflare Pages | Dockerå®¹å™¨ |
| **å®šæ—¶ä»»åŠ¡** | Cron Triggers | node-cron |

---

## ğŸ¯ ä¿ç•™çš„åŠŸèƒ½

âœ… **å®Œå…¨ä¿ç•™ï¼Œæ— ä»»ä½•åŠŸèƒ½ç¼ºå¤±ï¼š**

1. **å¤šäº‘æœåŠ¡å•†æ”¯æŒ**
   - DigitalOceanå®Œæ•´ç®¡ç†
   - Linodeå®Œæ•´ç®¡ç†
   - Azureå®Œæ•´ç®¡ç†

2. **æœåŠ¡å™¨ç®¡ç†**
   - åˆ›å»º/åˆ é™¤å®ä¾‹
   - å¯åŠ¨/åœæ­¢/é‡å¯
   - IPåœ°å€ç®¡ç†
   - åŒºåŸŸ/é•œåƒ/é…ç½®é€‰æ‹©

3. **APIå¯†é’¥ç®¡ç†**
   - AES-256-GCMåŠ å¯†å­˜å‚¨
   - å¤šå¯†é’¥åˆ‡æ¢
   - å¥åº·çŠ¶æ€æ£€æŸ¥
   - æ‰¹é‡éªŒè¯

4. **ç”¨æˆ·ç³»ç»Ÿ**
   - ç”¨æˆ·è®¤è¯
   - æƒé™ç®¡ç†
   - å¯†ç åŠ å¯†
   - Sessionç®¡ç†

5. **Telegramé›†æˆ**
   - ä¸ªäººBoté€šçŸ¥
   - ç®¡ç†å‘˜æ±‡æ€»
   - å®šæ—¶å¥åº·æ£€æŸ¥
   - å®æ—¶å‘Šè­¦

6. **å‰ç«¯ç•Œé¢**
   - æ·±è‰²/æµ…è‰²ä¸»é¢˜
   - å“åº”å¼è®¾è®¡
   - åŠ¨æ€èƒŒæ™¯
   - å®æ—¶æ›´æ–°

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

```
æ ¹ç›®å½•æ–°å¢:
â”œâ”€â”€ Dockerfile                     # Dockeré•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml             # Docker Composeé…ç½®
â”œâ”€â”€ .dockerignore                  # Dockeræ„å»ºå¿½ç•¥
â”œâ”€â”€ .env.example                   # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ start-docker.sh                # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ DOCKER_DEPLOYMENT.md           # éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ DOCKER_README.md               # å¿«é€Ÿå…¥é—¨
â”œâ”€â”€ DOCKER_CHANGELOG.md            # å˜æ›´æ—¥å¿—
â””â”€â”€ tsconfig.docker.json           # TSé…ç½®

functions/ æ–°å¢:
â”œâ”€â”€ server.ts                      # ExpressæœåŠ¡å™¨
â”œâ”€â”€ config.ts                      # é…ç½®ç®¡ç†
â”œâ”€â”€ scheduler.ts                   # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ middleware/                    # ä¸­é—´ä»¶ç›®å½•
â”‚   â”œâ”€â”€ cors.ts
â”‚   â”œâ”€â”€ session.ts
â”‚   â”œâ”€â”€ auth.ts
â”‚   â””â”€â”€ error-handler.ts
â”œâ”€â”€ routes/                        # è·¯ç”±ç³»ç»Ÿ
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ api-loader.ts
â””â”€â”€ shared/
    â”œâ”€â”€ db-adapter.ts              # SQLiteé€‚é…å™¨
    â”œâ”€â”€ kv-adapter.ts              # KVé€‚é…å™¨
    â””â”€â”€ db-init.ts                 # æ•°æ®åº“åˆå§‹åŒ–
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### æ–¹æ³•1ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆå·²å®Œæˆï¼‰
chmod +x start-docker.sh

# 2. è¿è¡Œè„šæœ¬
./start-docker.sh

# 3. è®¿é—®é¢æ¿
# http://localhost:3000
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®
cp .env.example .env
nano .env  # ä¿®æ”¹åŠ å¯†å¯†é’¥å’Œç®¡ç†å‘˜è´¦æˆ·

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 4. è®¿é—®é¢æ¿
# http://localhost:3000
```

---

## âš ï¸ é‡è¦æç¤º

### å¿…é¡»é…ç½®çš„ç¯å¢ƒå˜é‡

1. **ENCRYPTION_KEY**ï¼ˆå¿…é¡»ï¼‰
   - 64å­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²
   - ç”Ÿæˆæ–¹æ³•ï¼š`node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
   - âš ï¸ ä¸¢å¤±æ­¤å¯†é’¥å°†æ— æ³•è§£å¯†å·²å­˜å‚¨çš„APIå¯†é’¥

2. **SESSION_SECRET**ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
   - éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºSessionåŠ å¯†
   - ç”Ÿæˆæ–¹æ³•åŒä¸Š

3. **ADMIN_USER & ADMIN_PASSWORD**ï¼ˆæ¨èä¿®æ”¹ï¼‰
   - ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯
   - é»˜è®¤ï¼šadmin/admin123
   - âš ï¸ ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹

### æ•°æ®æŒä¹…åŒ–

- æ•°æ®å­˜å‚¨åœ¨Dockerå·ï¼š`cloudpanel_data`
- åŒ…å«ï¼šSQLiteæ•°æ®åº“ã€Sessionæ•°æ®ã€ç¼“å­˜æ–‡ä»¶
- å¤‡ä»½å‘½ä»¤å·²åœ¨æ–‡æ¡£ä¸­æä¾›

### å®‰å…¨å»ºè®®

1. ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
2. ä½¿ç”¨HTTPSï¼ˆé…ç½®åå‘ä»£ç†ï¼‰
3. å¦¥å–„ä¿ç®¡åŠ å¯†å¯†é’¥
4. å®šæœŸå¤‡ä»½æ•°æ®

---

## ğŸ“Š æŠ€æœ¯æ ˆ

### åç«¯
- **Runtime**: Node.js 20 (Alpine)
- **Framework**: Express 4.18
- **Database**: SQLite 3 (better-sqlite3)
- **Language**: TypeScript 5.3

### ä¾èµ–åº“
- `bcryptjs`: å¯†ç åŠ å¯†
- `better-sqlite3`: SQLiteæ•°æ®åº“
- `cron`: å®šæ—¶ä»»åŠ¡
- `dotenv`: ç¯å¢ƒå˜é‡
- `express`: Webæ¡†æ¶

### å¼€å‘å·¥å…·
- `tsx`: TypeScriptæ‰§è¡Œå™¨
- `typescript`: TypeScriptç¼–è¯‘å™¨
- ç±»å‹å®šä¹‰: @types/*

---

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³å¯åš

1. âœ… å¯åŠ¨DockeræœåŠ¡
2. âœ… ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
3. âœ… æ·»åŠ äº‘æœåŠ¡å•†APIå¯†é’¥
4. âœ… é…ç½®Telegramé€šçŸ¥ï¼ˆå¯é€‰ï¼‰

### å¯é€‰é…ç½®

1. é…ç½®åå‘ä»£ç†ï¼ˆNginx/Caddy/Traefikï¼‰
2. å¯ç”¨HTTPS
3. é…ç½®åŸŸå
4. è®¾ç½®å®šæ—¶å¤‡ä»½
5. é…ç½®èµ„æºé™åˆ¶

### é«˜çº§åŠŸèƒ½

1. é›†æˆç›‘æ§ç³»ç»Ÿ
2. æ—¥å¿—èšåˆ
3. é›†ç¾¤éƒ¨ç½²
4. CI/CDè‡ªåŠ¨åŒ–

---

## ğŸ“ å¸®åŠ©ä¸æ”¯æŒ

### æ–‡æ¡£

- [å¿«é€Ÿå…¥é—¨](./DOCKER_README.md)
- [è¯¦ç»†éƒ¨ç½²æŒ‡å—](./DOCKER_DEPLOYMENT.md)
- [å˜æ›´æ—¥å¿—](./DOCKER_CHANGELOG.md)

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# é‡å¯æœåŠ¡
docker-compose restart

# åœæ­¢æœåŠ¡
docker-compose stop

# æ›´æ–°åº”ç”¨
git pull && docker-compose up -d --build

# å¤‡ä»½æ•°æ®
docker run --rm \
  -v cloudpanel_data:/data \
  -v $(pwd)/backup:/backup \
  alpine tar czf /backup/cloudpanel-$(date +%Y%m%d).tar.gz -C /data .
```

---

## âœ¨ æ€»ç»“

CloudPanelå·²æˆåŠŸé‡æ„ä¸ºDockerç‰ˆæœ¬ï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **æ˜“éƒ¨ç½²** - ä¸€é”®å¯åŠ¨ï¼Œæ— éœ€å¤æ‚é…ç½®
2. **å¯ç§»æ¤** - è·¨å¹³å°è¿è¡Œï¼Œç¯å¢ƒä¸€è‡´
3. **æ˜“ç»´æŠ¤** - å®¹å™¨åŒ–ç®¡ç†ï¼Œå‡çº§ç®€å•
4. **åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰åŸæœ‰åŠŸèƒ½100%ä¿ç•™
5. **å®‰å…¨å¯é ** - æ•°æ®æŒä¹…åŒ–ï¼ŒåŠ å¯†å­˜å‚¨

ç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•æ”¯æŒDockerçš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²CloudPanelï¼Œäº«å—å®Œæ•´çš„äº‘æœåŠ¡å™¨ç®¡ç†åŠŸèƒ½ï¼

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
